<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Check Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .service { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .healthy { background-color: #d4edda; }
        .unhealthy { background-color: #f8d7da; }
        .unknown { background-color: #fff3cd; }
        button { padding: 10px 20px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Health Check Debug</h1>
    <button onclick="runHealthCheck()">Run Health Check</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="results"></div>
    <div id="logs">
        <h3>Console Logs:</h3>
        <pre id="logOutput"></pre>
    </div>

    <script>
        // Mock the backend service URLs
        const BACKEND_SERVICES = {
            PRODUCT_SERVICE: 'http://localhost',
            USER_SERVICE: 'http://localhost',
            CHECKOUT_SERVICE: 'http://localhost',
            ANALYTICS_SERVICE: 'http://localhost:8083'
        };

        // Capture console.log output
        const originalLog = console.log;
        const logOutput = document.getElementById('logOutput');
        console.log = function(...args) {
            originalLog.apply(console, args);
            logOutput.textContent += args.join(' ') + '\n';
        };

        async function fetchWithTimeout(url, options = {}, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        async function getSystemHealth() {
            const health = {};

            // Test product service via NGINX
            try {
                const response = await fetchWithTimeout(
                    `${BACKEND_SERVICES.PRODUCT_SERVICE}/api/v1/products`,
                    {},
                    5000
                );
                health['product'] = response.ok ? 'healthy' : 'unhealthy';
                console.log(`Product Service Health: ${response.status} -> ${health['product']}`);
            } catch (error) {
                health['product'] = 'unknown';
                console.log(`Product Service Health: Error -> unknown`, error);
            }

            // Test user service via NGINX (403 is expected for unauthenticated requests, so it's healthy)
            try {
                const response = await fetchWithTimeout(
                    `${BACKEND_SERVICES.USER_SERVICE}/api/v1/users`,
                    {},
                    5000
                );
                // 200 (OK) or 401/403 (auth required) means service is healthy
                const isHealthy = response.ok || response.status === 401 || response.status === 403;
                health['user'] = isHealthy ? 'healthy' : 'unhealthy';
                console.log(`User Service Health: ${response.status} -> ${health['user']} (isHealthy: ${isHealthy})`);
            } catch (error) {
                health['user'] = 'unknown';
                console.log(`User Service Health: Error -> unknown`, error);
            }

            // Test checkout service via NGINX
            try {
                const response = await fetchWithTimeout(
                    `${BACKEND_SERVICES.CHECKOUT_SERVICE}/health`,
                    {},
                    5000
                );
                health['checkout'] = response.ok ? 'healthy' : 'unhealthy';
                console.log(`Checkout Service Health: ${response.status} -> ${health['checkout']}`);
            } catch (error) {
                // If /health doesn't exist, try another approach
                try {
                    const fallbackResponse = await fetchWithTimeout(
                        `${BACKEND_SERVICES.CHECKOUT_SERVICE}/api/v1/orders`,
                        {},
                        3000
                    );
                    // Any response (even 404/401) means the service is running
                    const isHealthy = fallbackResponse.status < 500;
                    health['checkout'] = isHealthy ? 'healthy' : 'unhealthy';
                    console.log(`Checkout Service Health (fallback): ${fallbackResponse.status} -> ${health['checkout']} (isHealthy: ${isHealthy})`);
                } catch (fallbackError) {
                    health['checkout'] = 'unknown';
                    console.log(`Checkout Service Health: Fallback Error -> unknown`, fallbackError);
                }
            }

            // Test analytics service directly
            try {
                const response = await fetchWithTimeout(
                    `${BACKEND_SERVICES.ANALYTICS_SERVICE}/health`,
                    {},
                    5000
                );
                health['analytics'] = response.ok ? 'healthy' : 'unhealthy';
                console.log(`Analytics Service Health: ${response.status} -> ${health['analytics']}`);
            } catch (error) {
                health['analytics'] = 'unknown';
                console.log(`Analytics Service Health: Error -> unknown`, error);
            }

            console.log('Final Health Check Results:', health);
            return health;
        }

        async function runHealthCheck() {
            console.log('=== Starting Health Check ===');
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Running health checks...</p>';
            
            try {
                const health = await getSystemHealth();
                
                let html = '<h3>Health Check Results:</h3>';
                for (const [service, status] of Object.entries(health)) {
                    html += `<div class="service ${status}">
                        <strong>${service.toUpperCase()} Service:</strong> ${status}
                    </div>`;
                }
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = '<p style="color: red;">Error running health checks: ' + error.message + '</p>';
                console.error('Health check error:', error);
            }
        }

        function clearLogs() {
            logOutput.textContent = '';
        }

        // Auto-run health check on page load
        window.addEventListener('load', runHealthCheck);
    </script>
</body>
</html> 